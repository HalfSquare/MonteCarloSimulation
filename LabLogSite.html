<!DOCTYPE html>
<html>
<head>
	<script>
	 window.onload = function() {
	 	document.getElementById("submit").onclick = function() {
	 		var token = "";
	 		var projectID = "";
	 		var originalContent = "";
	 		var contentArray;
	 		var name = "";
	 		var pageSlug = "";
	 		let username = document.getElementById("username").value
	 		let password = document.getElementById("password").value
	 		var x = 'grant_type=password&username=' + username + '&password=' + password;
	 		var table;
	 		// However to make it work, we are going to use the cors-anywhere free service to bypass this
			var proxy = 'https://cors-anywhere.herokuapp.com/';
	 		var Url = "https://gitlab.ecs.vuw.ac.nz/oauth/token";
	 		var xhr = new XMLHttpRequest();
	 		var xhr2 = new XMLHttpRequest();
	 		var xhr3 = new XMLHttpRequest();
	 		var xhr4 = new XMLHttpRequest();
	 		var xhr5 = new XMLHttpRequest();
	 		xhr.open('POST', proxy + Url, true);
			xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
			xhr.send(x);
			xhr.onreadystatechange = processRequest;
			 
			function processRequest(e) {
				if (xhr.readyState == 4 && xhr.status == 200) {
					var response1 = JSON.parse(xhr.responseText);
					token = response1.access_token;
					let userInfoURL = "https://gitlab.ecs.vuw.ac.nz/api/v4/users?username=" + username;
					xhr2.open('GET', userInfoURL, true);
					xhr2.setRequestHeader('Content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
					xhr2.send();
					xhr2.onreadystatechange = userInfo;
					var button = document.createElement("button");
					button.innerHTML = "Log lab arrival";
					var body = document.getElementsByTagName("body")[0];
					body.appendChild(button);
					button.addEventListener ("click", function() {
						labLogPageAddLog();
					});
					var button2 = document.createElement("button");
					button2.innerHTML = "Log lab leave";
					body.appendChild(button2);
					button2.addEventListener ("click", function() {
						labLogLeave();
					});
	 			}
	 		}

	 		function userInfo() {
	 			if (xhr2.readyState == 4 && xhr2.status == 200) {
		 			const data = JSON.parse(xhr2.responseText);
		 			let id = data[0].id
		 			name = data[0].name;
		 			let projectsUrl = "https://gitlab.ecs.vuw.ac.nz/api/v4/projects";
		 			xhr3.open('GET', projectsUrl, true);
					xhr3.setRequestHeader('Content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
					xhr3.setRequestHeader("Authorization", "Bearer " + token);
					xhr3.send();
					xhr3.onreadystatechange = allProjects;
				}
	 		}

	 		function allProjects() {
	 			if (xhr3.readyState == 4 && xhr3.status == 200) {
	 				const data = JSON.parse(xhr3.responseText);
	 				var newArray = data.filter(function (el) {
  						return el["namespace"].parent_id == 2988; 
  					})
					projectID = newArray[0]["id"];
					let wikiURL = "https://gitlab.ecs.vuw.ac.nz/api/v4/projects/" + projectID + "/wikis?with_content=1"
					xhr4.open('GET', wikiURL, true);
					xhr4.setRequestHeader('Content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
					xhr4.setRequestHeader("Authorization", "Bearer " + token);
					xhr4.send();
					xhr4.onreadystatechange = wikiPages;
	 			}
	 		}

	 		function wikiPages() {
	 			if (xhr4.readyState == 4 && xhr4.status == 200) {
	 				const data = JSON.parse(xhr4.responseText);
	 				var newArray = data.filter(function (el) {
  						return el["slug"].includes("Lab-time-log");
  					})
  					pageSlug = newArray[0].slug;
	 				let content = newArray[0].content;
					contentArray = content.split("\n");
					if (originalContent == "") {
						originalContent = content;
					}
	 				table = document.getElementById("myTable");
	 				table.innerHTML = "";
	 				for (i = 0; i < contentArray.length; i++) {
	 					var row = table.insertRow(table.rows.length);
						var cell = row.insertCell(0);
						cell.innerHTML = contentArray[i];
	 				}
	 			}
	 		}

	 		function labLogPageAddLog() {
	 			let content = contentArray;
	 			//Checks if space is available for new log
	 			if (content[content.length-1].replace(/ /g, '') == "||||||") {
	 				var firstName = name.split(" ")[0];
	 				var sessionIndex;
	 				var emptyIndex;
	 				var i; 
	 				for (i = content.length-1; i > 0; i--) {
	 					var lineStr = content[i].toLowerCase();
	 					if (lineStr.includes("lab session")) {
	 						session = i;
	 						break;
	 					}
	 					else if (lineStr.includes(firstName.toLowerCase())) {
	 						return; //TODO: Add new lab session
	 					}
	 					else if (!lineStr.includes("-: |") && !lineStr.includes("| lab date |")) {
	 						emptyIndex = i;
	 					}
	 				}
	 				var date = new Date();
	 				let month = (date.getMonth()+1) < 10 ? "0" + (date.getMonth()+1) : (date.getMonth()+1);
	 				let labDate = date.getDate() + "/" + month + "/" + date.getFullYear();
	 				let labTime = date.getHours() < 12 ? "Morning" : "Afternoon";
	 				let arrivalTime = date.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
	 				content[emptyIndex] = "| "+labDate+" | "+labTime+" | "+firstName+" | "+arrivalTime+" | |";
	 				publishWikiPageEdit(content.join("\n"));
	 			}
	 			else {
	 				// TODO: Add new lab session
	 			}
	 		}

	 		function labLogLeave() {
	 			var index;
	 			var firstName = name.split(" ")[0];
	 			for (i = contentArray.length-1; i > 0; i--) {
 					var lineStr = contentArray[i].toLowerCase();
 					if (lineStr.includes("lab session")) {
 						return;
 					}
 					else if (lineStr.includes(firstName.toLowerCase())) {
 						index = i;
 						break;
 					}
 				}
 				var date = new Date();
 				let time = date.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
 				let log = contentArray[index];
 				let leaveLog = log.slice(0, -1) + time + " |";
 				contentArray[index] = leaveLog;
 				publishWikiPageEdit(contentArray.join("\n"));
	 		}

	 	function publishWikiPageEdit(content) {
	 			let wikiURL = "https://gitlab.ecs.vuw.ac.nz/api/v4/projects/" + projectID + "/wikis/" + encodeURIComponent(pageSlug, "UTF-8");
				xhr5.open('PUT', wikiURL, true);
				xhr5.setRequestHeader('Content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
				xhr5.setRequestHeader("Authorization", "Bearer " + token);
				xhr5.send("content="+content);
				xhr5.onreadystatechange = function(){
					if (xhr5.readyState == 4 && xhr5.status == 200) {
						let wikiURL = "https://gitlab.ecs.vuw.ac.nz/api/v4/projects/" + projectID + "/wikis?with_content=1"
						xhr4.open('GET', wikiURL, true);
						xhr4.setRequestHeader('Content-type', 'application/x-www-form-urlencoded;charset=UTF-8');
						xhr4.setRequestHeader("Authorization", "Bearer " + token);
						xhr4.send();
						xhr4.onreadystatechange = wikiPages;
						var button = document.createElement("button");
						button.innerHTML = "Undo";
						var body = document.getElementsByTagName("body")[0];
						if (body.childElementCount == 3) {
							body.appendChild(button);
						}
						button.addEventListener ("click", function() {
							publishWikiPageEdit(originalContent);
						});
					}
				}
	 		}
	 	}
	}
	</script>
</head>

<body>
<center>
	Log in to gitlab
<br><br>
  <div class="container">
    <label for="uname"><b>Username</b></label>
    <input type="text" placeholder="Enter Username" name="uname" id="username" required>

    <label for="psw"><b>Password</b></label>
    <input type="password" placeholder="Enter Password" name="psw" id="password" required>

    <button type="submit" id="submit">Login</button>
  </div>
 <br><br>
 <table border="1" id="myTable">
 </table>
 </center>
</body>
</html>