<!doctype html>
<meta charset="UTF-8">

<head>
    <link rel="stylesheet" href="styles.css">
    <title>Deploy</title>
</head>

<body>
<header id="pageHeader">
    <div style="width: 100%; display: table;">
        <div style="display: table-row">
            <div style="width: 100%; text-align: left; display: table-cell;">
                <label id="status"></label>
            </div>
            <div style="display: table-cell;">
                <a href="http://www.google.com">Recommended</a>
                <br><br>
                <a href="http://www.google.com">Latest</a>
            </div>
        </div>
    </div>
</header>

<article id="mainArticle">
    <table id="releaseTable">
    </table>
</article>

<nav id="mainNav">
    <img src="img.jpg" alt="Image of big rocket">
</nav>

<footer id="pageFooter">
    Developed by Group 15
</footer>

<script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-storage.js"></script>
<script>
    /**
     * Uses a json array to read the tags into a table
     */
    function parseAndDisplayTable(releases) {
        const data = JSON.parse(releases);

        table = document.getElementById("releaseTable");
        table.innerHTML = "";
        let row = table.insertRow(table.rows.length);
        Object.keys(data[0]).forEach((property) => {
            let cell = row.insertCell();
            cell.innerHTML = "<b>" + property + "</b>";
        });
        data.forEach((version) => {
            let row = table.insertRow(table.rows.length);
            Object.keys(version).forEach((property) => {
                let cell = row.insertCell();
                if (Array.isArray(version[property])) {
                  let smallTable = "";
                  version[property].forEach((note) => {
                      smallTable += "- " + note;
                      smallTable += "<br>"
                  });
                  cell.innerHTML = smallTable;
                }
                else if (property === "Link") {
                    cell.innerHTML = "<a href='" + version[property] + "'><i>Download</i></a>"
                }
                else {
                    cell.innerHTML = version[property];
                }
            });
        });
    }

    ///**
    // * @deprecated
    // * uses a local file to retrieve tag info
    // */
    // function readTextFile(fileName) {
    //     //https://stackoverflow.com/questions/14446447/how-to-read-a-local-text-file
    //     let file = new XMLHttpRequest();
    //     file.open("GET", fileName, false)
    //     file.onreadystatechange = () =>
    //     {
    //         if(file.readyState === 4)
    //         {
    //             if(file.status === 200 || file.status === 0)
    //             {
    //                 parseAndDisplayTable(file.response);
    //             }
    //         }
    //     }
    //     file.send(null);
    // }

    /**
     * Uses the firebase to get the tags file
     */
    function getGitlabTags() {
        let firebaseConfig = {
            apiKey: "AIzaSyBtLSSqMjyBnG9UWV1Z-HgWNdt6Q-oMoWM",
            authDomain: "rocketboydeploy.firebaseapp.com",
            databaseURL: "https://rocketboydeploy.firebaseio.com/",
            projectId: "rocketboydeploy",
            storageBucket: "rocketboydeploy.appspot.com/files",
            messagingSenderId: "543132747659",
            appId: "1:543132747659:web:cd34b1666ef9065fd7d18e",
            measurementId: "G-4SXG9TY5L7"
        };
        firebase.initializeApp(firebaseConfig);

        // Get a reference to the storage service, which is used to create references in your storage bucket
        let storage = firebase.storage();
        let pathReference = storage.refFromURL('gs://rocketboydeploy.appspot.com/tags.json');
        pathReference.getDownloadURL().then((url) => {
            let xhr = new XMLHttpRequest();
            xhr.responseType = 'json';
            xhr.onload = function() {
                // Received the file so put it in the table
                let json = xhr.response;
                parseAndDisplayTable(JSON.stringify(json));
            };

            // cors tool
            let proxy = "https://cors-anywhere.herokuapp.com/"
            xhr.open('GET', proxy+url);
            xhr.send();

        }).catch(function(error) {
            console.log(error);
            // Handle any errors
            // Basically cry
        });


    }

    window.onload = function () {
        getGitlabTags();
        // parseAndDisplayTable(tags);
    }
</script>
</body>